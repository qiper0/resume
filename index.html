<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Markdown编辑器</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --border-color: #ddd;
            --code-bg: #2d3748;
            --header-color: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--bg-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border-color);
        }
        
        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
        }
        
        .editor-area, .preview-area {
            background: white;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #editor {
            width: 100%;
            height: calc(100vh - 30px);
            border: none;
            resize: none;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, monospace;
            font-size: 14px;
            line-height: 1.5;
            outline: none;
            padding: 0;
            background: white;
            tab-size: 4;
        }
        
        @media (max-width: 768px) {
            #editor {
                height: calc(50vh - 30px);
                font-size: 16px;
            }
        }
        
        .view-only {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px 15px;
            background: white;
            min-height: 100vh;
        }
        
        .markdown-content {
            font-size: 1em;
            line-height: 1.7;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .markdown-content h1 { 
            font-size: 1.8em; 
            margin: 0.8em 0 0.4em; 
            color: var(--header-color); 
            border-bottom: 1px solid #eee; 
            padding-bottom: 0.2em; 
        }
        .markdown-content h2 { 
            font-size: 1.5em; 
            margin: 1.2em 0 0.4em; 
            color: var(--header-color); 
            border-bottom: 1px solid #eee; 
            padding-bottom: 0.2em; 
        }
        .markdown-content h3 { 
            font-size: 1.3em; 
            margin: 1em 0 0.3em; 
            color: var(--header-color); 
        }
        .markdown-content h4 { 
            font-size: 1.1em; 
            margin: 0.9em 0 0.3em; 
            color: var(--header-color); 
        }
        .markdown-content p { 
            margin: 0.8em 0; 
        }
        .markdown-content ul, 
        .markdown-content ol { 
            margin: 0.8em 0; 
            padding-left: 1.5em; 
        }
        .markdown-content li { 
            margin: 0.4em 0; 
        }
        .markdown-content strong { 
            color: var(--header-color); 
            font-weight: 600; 
        }
        .markdown-content em { 
            color: #555; 
        }
        .markdown-content blockquote { 
            border-left: 3px solid var(--primary-color); 
            padding: 0.4em 0.8em; 
            margin: 0.8em 0; 
            background: var(--bg-color); 
            color: #555; 
        }
        .markdown-content code { 
            background: #f1f3f5; 
            padding: 2px 4px; 
            border-radius: 2px; 
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; 
            font-size: 0.9em; 
        }
        .markdown-content pre { 
            background: var(--code-bg); 
            color: #e2e8f0; 
            padding: 0.8em; 
            border-radius: 4px; 
            overflow-x: auto; 
            margin: 0.8em 0; 
            -webkit-overflow-scrolling: touch; 
        }
        .markdown-content pre code { 
            background: none; 
            padding: 0; 
            color: inherit; 
            font-size: 0.9em; 
        }
        .markdown-content table { 
            border-collapse: collapse; 
            margin: 0.8em 0; 
            width: 100%; 
            overflow-x: auto;
            display: block;
        }
        .markdown-content table th, 
        .markdown-content table td { 
            border: 1px solid #e1e4e8; 
            padding: 0.5em 0.8em; 
            text-align: left; 
            min-width: 80px;
        }
        .markdown-content table th { 
            background: #f6f8fa; 
            font-weight: 600; 
        }
        .markdown-content table tr:nth-child(even) { 
            background: #fafbfc; 
        }
        .markdown-content .task-list-item { 
            display: flex; 
            align-items: flex-start; 
            gap: 0.5em; 
        }
        .markdown-content .task-list-item input[type="checkbox"] { 
            margin-top: 0.3em; 
            flex-shrink: 0;
        }
        .markdown-content .task-list-item input[type="checkbox"]:checked + span { 
            text-decoration: line-through; 
            color: #6a737d; 
        }
        .markdown-content del { 
            text-decoration: line-through; 
            color: #6a737d; 
        }
        .markdown-content img { 
            max-width: 100%; 
            height: auto; 
            margin: 0.8em 0; 
        }
        .markdown-content a { 
            color: #0366d6; 
            text-decoration: none; 
            border-bottom: 1px solid rgba(3, 102, 214, 0.2); 
        }
        .markdown-content a:hover { 
            color: #0056b3; 
            border-bottom-color: #0366d6; 
        }
        .markdown-content hr { 
            border: none; 
            border-top: 1px solid #eaecef; 
            margin: 1.5em auto; 
            width: 80%; 
        }
        
        .save-status {
            position: fixed;
            bottom: 16px;
            right: 16px;
            padding: 6px 12px;
            background: rgba(74, 111, 165, 0.95);
            color: white;
            border-radius: 4px;
            font-size: 13px;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            z-index: 1000;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .save-status.show { 
            opacity: 1; 
        }
        .hidden { 
            display: none !important; 
        }
        
        /* 加载状态 */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="editMode" class="editor-container hidden">
        <div class="editor-area">
            <textarea id="editor" placeholder="在这里编辑Markdown文档..." spellcheck="false"></textarea>
        </div>
        <div class="preview-area">
            <div id="preview" class="markdown-content"></div>
        </div>
    </div>
    
    <div id="viewMode" class="view-only hidden">
        <div id="viewContent" class="markdown-content"></div>
    </div>
    
    <div id="saveStatus" class="save-status">已保存</div>

    <script>
        (function() {
            'use strict';
            
            // 常量配置
            const CONFIG = {
                SAVE_DELAY: 5000,
                PREVIEW_DELAY: 150,
                WECHAT_PREVIEW_DELAY: 200,
                WECHAT_SAVE_DELAY: 10000,
                CACHE_EXPIRY: 60000 // 60秒缓存
            };
            
            // 状态管理
            const state = {
                saveTimer: null,
                currentContent: '',
                isEditing: false,
                currentFile: '',
                isComposing: false,
                isWeChat: /micromessenger/i.test(navigator.userAgent),
                cache: new Map(),
                lastCacheTime: 0
            };
            
            // DOM 元素引用
            const elements = {
                editor: document.getElementById('editor'),
                preview: document.getElementById('preview'),
                viewContent: document.getElementById('viewContent'),
                editMode: document.getElementById('editMode'),
                viewMode: document.getElementById('viewMode'),
                saveStatus: document.getElementById('saveStatus')
            };
            
            // 工具函数
            const utils = {
                debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },
                
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                
                showSaveStatus(message) {
                    const el = elements.saveStatus;
                    el.textContent = message;
                    el.classList.add('show');
                    clearTimeout(this.statusTimer);
                    this.statusTimer = setTimeout(() => {
                        el.classList.remove('show');
                    }, 1500);
                },
                
                setLoading(isLoading) {
                    document.body.classList.toggle('loading', isLoading);
                }
            };
            
            // Markdown 解析器
            const markdownParser = {
                // 内联元素处理
                processInline(text) {
                    if (!text) return '';
                    
                    // 使用预编译正则表达式
                    const patterns = [
                        [/\*\*\*(.*?)\*\*\*|___(.*?)___/g, '<strong><em>$1$2</em></strong>'],
                        [/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>'],
                        [/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>'],
                        [/~~(.*?)~~/g, '<del>$1</del>'],
                        [/`([^`]+)`/g, '<code>$1</code>'],
                        [/\[([^\]]+)\]\(([^)"\s]+)(?:\s+"([^"]+)")?\)/g, 
                            (_, text, url, title) => `<a href="${url}"${title ? ` title="${title}"` : ''} target="_blank">${text}</a>`],
                        [/!\[([^\]]*)\]\(([^)"\s]+)(?:\s+"([^"]+)")?\)/g,
                            (_, alt, src, title) => `<img src="${src}" alt="${alt}"${title ? ` title="${title}"` : ''} loading="lazy">`],
                        [/<([^>]+)>/g, (_, url) => {
                            if (/^https?:\/\//.test(url)) return `<a href="${url}" target="_blank">${url}</a>`;
                            if (/^mailto:/.test(url)) return `<a href="${url}">${url.substring(7)}</a>`;
                            return `<${url}>`;
                        }]
                    ];
                    
                    return patterns.reduce((result, [regex, replacement]) => {
                        return result.replace(regex, replacement);
                    }, text);
                },
                
                // 生成缓存键
                getCacheKey(text) {
                    return text.length < 1000 ? text : text.substring(0, 500) + text.length + text.substring(text.length - 500);
                },
                
                // 解析完整 Markdown
                parse(text) {
                    if (!text) return '';
                    
                    const now = Date.now();
                    const cacheKey = this.getCacheKey(text);
                    
                    // 检查缓存
                    const cached = state.cache.get(cacheKey);
                    if (cached && now - cached.time < CONFIG.CACHE_EXPIRY) {
                        return cached.html;
                    }
                    
                    let html = text;
                    
                    // 处理代码块
                    html = html.replace(/```[\s\S]*?```/g, (match) => {
                        const codeMatch = match.match(/^```(\w*)\n([\s\S]*?)\n```$/);
                        if (codeMatch) {
                            const [, lang, code] = codeMatch;
                            const escapedCode = utils.escapeHtml(code.trim());
                            return `<pre><code class="language-${lang || 'text'}">${escapedCode}</code></pre>`;
                        }
                        return match;
                    });
                    
                    // 处理表格
                    const tableRegex = /^(\|.+\|(?:\r?\n|$))+/gm;
                    html = html.replace(tableRegex, (match) => {
                        const rows = match.trim().split('\n')
                            .map(row => row.trim().replace(/^\||\|$/g, '').split('|').map(cell => cell.trim()));
                        
                        if (rows.length < 2) return match;
                        
                        const isSeparator = (cell) => /^:?-+:?$/.test(cell);
                        const hasHeader = rows.length > 1 && rows[1].every(isSeparator);
                        
                        let tableHtml = '<div class="table-container"><table>';
                        
                        if (hasHeader && rows.length >= 3) {
                            const [header, , ...dataRows] = rows;
                            tableHtml += `<thead><tr>${header.map(h => `<th>${this.processInline(h)}</th>`).join('')}</tr></thead>`;
                            tableHtml += `<tbody>${dataRows.map(row => 
                                `<tr>${row.map(cell => `<td>${this.processInline(cell)}</td>`).join('')}</tr>`
                            ).join('')}</tbody>`;
                        } else {
                            tableHtml += `<tbody>${rows.map(row => 
                                `<tr>${row.map(cell => `<td>${this.processInline(cell)}</td>`).join('')}</tr>`
                            ).join('')}</tbody>`;
                        }
                        
                        tableHtml += '</table></div>';
                        return tableHtml;
                    });
                    
                    // 逐行处理
                    const lines = html.split('\n');
                    const result = [];
                    let inBlockquote = false;
                    let inList = false;
                    let listType = '';
                    let i = 0;
                    
                    while (i < lines.length) {
                        const line = lines[i];
                        
                        // 跳过已处理的 HTML 块
                        if (line.includes('<pre') || line.includes('<table') || line.includes('<div class="table-container"')) {
                            result.push(line);
                            i++;
                            continue;
                        }
                        
                        const trimmed = line.trim();
                        
                        // 标题
                        const headingMatch = trimmed.match(/^(#{1,6})\s+(.+)/);
                        if (headingMatch) {
                            const [, hashes, content] = headingMatch;
                            result.push(`<h${hashes.length}>${this.processInline(content)}</h${hashes.length}>`);
                            i++;
                            continue;
                        }
                        
                        // 水平线
                        if (/^[-*_]{3,}$/.test(trimmed)) {
                            result.push('<hr>');
                            i++;
                            continue;
                        }
                        
                        // 引用
                        if (trimmed.startsWith('>')) {
                            if (!inBlockquote) result.push('<blockquote>');
                            result.push(`<p>${this.processInline(trimmed.substring(1).trim())}</p>`);
                            inBlockquote = true;
                            i++;
                            continue;
                        } else if (inBlockquote) {
                            result.push('</blockquote>');
                            inBlockquote = false;
                        }
                        
                        // 列表
                        const listMatch = trimmed.match(/^(\s*)([-*+]|\d+\.)\s+(.*)/);
                        if (listMatch) {
                            const [, , marker, content] = listMatch;
                            const type = /^\d+\.$/.test(marker) ? 'ol' : 'ul';
                            
                            if (!inList || listType !== type) {
                                if (inList) result.push(`</${listType}>`);
                                result.push(`<${type}>`);
                                inList = true;
                                listType = type;
                            }
                            
                            // 任务列表
                            const taskMatch = content.match(/^\[(x|\s)\]\s+(.*)/i);
                            if (taskMatch) {
                                const checked = taskMatch[1].toLowerCase() === 'x';
                                result.push(
                                    `<li class="task-list-item">
                                        <input type="checkbox" disabled${checked ? ' checked' : ''}>
                                        <span>${this.processInline(taskMatch[2])}</span>
                                    </li>`
                                );
                            } else {
                                result.push(`<li>${this.processInline(content)}</li>`);
                            }
                            
                            i++;
                            continue;
                        } else if (inList) {
                            result.push(`</${listType}>`);
                            inList = false;
                            listType = '';
                        }
                        
                        // 段落
                        if (trimmed) {
                            let paragraph = trimmed;
                            let j = i + 1;
                            
                            // 合并连续的非空行
                            while (j < lines.length && lines[j].trim() && 
                                   !lines[j].trim().match(/^#{1,6}\s|^[-*_]{3,}$|^>|^(\s*)([-*+]|\d+\.)\s+/)) {
                                paragraph += ' ' + lines[j].trim();
                                j++;
                            }
                            
                            result.push(`<p>${this.processInline(paragraph)}</p>`);
                            i = j;
                        } else {
                            result.push('');
                            i++;
                        }
                    }
                    
                    // 闭合未结束的标签
                    if (inBlockquote) result.push('</blockquote>');
                    if (inList) result.push(`</${listType}>`);
                    
                    const finalHtml = result.join('\n').replace(/(<p>\s*<\/p>)/g, '');
                    
                    // 更新缓存
                    state.cache.set(cacheKey, {
                        html: finalHtml,
                        time: now
                    });
                    
                    // 清理过期缓存
                    if (now - state.lastCacheTime > CONFIG.CACHE_EXPIRY) {
                        for (const [key, value] of state.cache.entries()) {
                            if (now - value.time > CONFIG.CACHE_EXPIRY) {
                                state.cache.delete(key);
                            }
                        }
                        state.lastCacheTime = now;
                    }
                    
                    return finalHtml;
                }
            };
            
            // 文件操作
            const fileManager = {
                async save() {
                    const content = elements.editor.value;
                    if (content === state.currentContent || !state.currentFile) return;
                    
                    try {
                        const response = await fetch(state.currentFile, {
                            method: 'PUT',
                            body: content,
                            headers: { 
                                'Content-Type': 'text/markdown',
                                'Cache-Control': 'no-cache'
                            }
                        });
                        
                        if (response.ok) {
                            state.currentContent = content;
                            utils.showSaveStatus('已保存');
                        } else {
                            utils.showSaveStatus('保存失败');
                        }
                    } catch (error) {
                        console.error('保存失败:', error);
                        utils.showSaveStatus('保存失败');
                    }
                },
                
                async load(filename, isEditMode) {
                    utils.setLoading(true);
                    
                    try {
                        const response = await fetch(filename, {
                            headers: { 'Cache-Control': 'no-cache' }
                        });
                        
                        const content = response.ok ? await response.text() : '';
                        
                        if (isEditMode) {
                            elements.editor.value = content || '# 新建文档\n\n开始编辑你的文档...';
                            state.currentContent = elements.editor.value;
                            updatePreview();
                            elements.editMode.classList.remove('hidden');
                            document.title = `编辑: ${filename}`;
                        } else {
                            elements.viewContent.innerHTML = response.ok ? 
                                markdownParser.parse(content) : 
                                `<h1>文件未找到</h1><p>请求的文件不存在：${filename}</p>`;
                            elements.viewMode.classList.remove('hidden');
                            document.title = response.ok ? 
                                (content.split('\n')[0]?.replace(/^#\s*/, '') || filename) : '文件未找到';
                        }
                        
                        state.currentFile = filename;
                        state.isEditing = isEditMode;
                    } catch (error) {
                        console.error('加载失败:', error);
                        
                        if (isEditMode) {
                            elements.editor.value = `# 加载失败\n\n无法加载文件: ${filename}`;
                            state.currentContent = elements.editor.value;
                            updatePreview();
                            elements.editMode.classList.remove('hidden');
                        } else {
                            elements.viewContent.innerHTML = 
                                `<h1>加载失败</h1><p>无法加载文件：${filename}</p>`;
                            elements.viewMode.classList.remove('hidden');
                        }
                    } finally {
                        utils.setLoading(false);
                    }
                },
                
                startAutoSave() {
                    clearTimeout(state.saveTimer);
                    const delay = state.isWeChat ? CONFIG.WECHAT_SAVE_DELAY : CONFIG.SAVE_DELAY;
                    state.saveTimer = setTimeout(() => this.save(), delay);
                }
            };
            
            // 预览更新
            const updatePreview = utils.debounce(() => {
                if (!state.isComposing) {
                    const content = elements.editor.value;
                    elements.preview.innerHTML = markdownParser.parse(content);
                }
            }, state.isWeChat ? CONFIG.WECHAT_PREVIEW_DELAY : CONFIG.PREVIEW_DELAY);
            
            // 事件处理器
            const eventHandlers = {
                handleEditorInput() {
                    if (!state.isComposing) updatePreview();
                    fileManager.startAutoSave();
                },
                
                handleEditorBlur() {
                    fileManager.save();
                },
                
                handleCompositionStart() {
                    state.isComposing = true;
                },
                
                handleCompositionEnd() {
                    state.isComposing = false;
                    updatePreview();
                },
                
                handleBeforeUnload(e) {
                    if (state.isEditing && elements.editor.value !== state.currentContent) {
                        e.preventDefault();
                        e.returnValue = '有未保存的更改，确定要离开吗？';
                    }
                }
            };
            
            // 初始化
            function init() {
                // 微信环境优化
                if (state.isWeChat) {
                    document.body.classList.add('wechat-mode');
                }
                
                // 解析URL参数
                const params = new URLSearchParams(window.location.search);
                const editFile = params.get('edit');
                const viewFile = params.get('file');
                
                // 设置事件监听器
                if (editFile) {
                    elements.editor.addEventListener('compositionstart', eventHandlers.handleCompositionStart);
                    elements.editor.addEventListener('compositionend', eventHandlers.handleCompositionEnd);
                    elements.editor.addEventListener('input', eventHandlers.handleEditorInput);
                    elements.editor.addEventListener('blur', eventHandlers.handleEditorBlur);
                    
                    fileManager.load(editFile, true);
                } else {
                    fileManager.load(viewFile || 'README.md', false);
                }
                
                // 页面卸载事件
                window.addEventListener('beforeunload', eventHandlers.handleBeforeUnload);
                
                // 优化滚动性能
                if ('scrollRestoration' in history) {
                    history.scrollRestoration = 'manual';
                }
            }
            
            // 启动应用
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>